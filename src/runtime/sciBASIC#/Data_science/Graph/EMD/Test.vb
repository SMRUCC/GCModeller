Imports System
Imports ClassLibrary1.com.telmomenezes.jfastemd


''' <summary>
''' @author Telmo Menezes (telmo@telmomenezes.com)
''' 
''' </summary>
Public Module Test
    Friend a0 As Double() = New Double() {1.0, 0.0, 0.0, 0.0}
    Friend a1 As Double() = New Double() {0.0, 1.0, 0.0, 0.0}
    Friend a2 As Double() = New Double() {0.0, 1.0, 1.0, 0.0}
    Friend b0 As Double() = New Double() {1.0, 0.31350830458876927, 0.475451529763324, 0.710099174235318, 0.81805479598637132, 0.85017054824513782, 0.70911173930236449, 0.34214075762243179, 0.0, 0.0, 0.86487157552862248, 0.0, 0.0, 0.22964068237385879, 0.32854154105225764, 0.41240916326716803, 0.25565501097278343, 0.0, 0.0, 0.0, 0.96883672896087025, 0.0, 0.15675415229438464, 0.25565501097278343, 0.44738416173897588, 0.54935360703637948, 0.4274423997306564, 0.0, 0.0, 0.0, 0.98970358951396387, 0.0, 0.0, 0.36597666561180608, 0.49450429339199403, 0.6613006436919866, 0.52634325840905516, 0.0, 0.0, 0.0, 0.95017321763684714, 0.0989008586783988, 0.0989008586783988, 0.39560343471359521, 0.58655501528101028, 0.710099174235318, 0.63556310233476732, 0.25565501097278343, 0.0, 0.0, 0.85700916294638441, 0.0, 0.0, 0.40425358481570628, 0.58419655202504106, 0.7250339741455023, 0.69005897567369445, 0.34214075762243179, 0.0, 0.0, 0.69990313925701275, 0.0, 0.15675415229438464, 0.27764981240652642, 0.53994247497922931, 0.62344932891507476, 0.61603551704210224, 0.31350830458876927, 0.0, 0.0, 0.434403964700911, 0.0, 0.0, 0.0, 0.38639483466824343, 0.434403964700911, 0.27764981240652642, 0.0989008586783988, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0}
    Friend b1 As Double() = New Double() {0.76905582796720584, 0.5431277903401206, 0.74000488702188272, 0.94313296511798528, 1.0, 0.86083718078863347, 0.60141048861497992, 0.0, 0.0, 0.0, 0.3620851935600804, 0.0, 0.0, 0.0, 0.0, 0.1810425967800402, 0.1810425967800402, 0.0, 0.0, 0.0, 0.80734708040111436, 0.28694572692954451, 0.3620851935600804, 0.3620851935600804, 0.60141048861497992, 0.50825082517253606, 0.0, 0.0, 0.0, 0.0, 0.84073578366987933, 0.1810425967800402, 0.50825082517253606, 0.68929342195257615, 0.78245308539502012, 0.626304483621074, 0.42036789183493967, 0.0, 0.0, 0.0, 0.8189574032199598, 0.42036789183493967, 0.649030920489625, 0.7241703871201608, 0.7241703871201608, 0.83007351726966516, 0.28694572692954451, 0.0, 0.0, 0.0, 0.87033601873261646, 0.42036789183493967, 0.50825082517253606, 0.70731361876448418, 0.921047483801923, 0.75493405063912911, 0.626304483621074, 0.0, 0.0, 0.0, 0.573891453859089, 0.3620851935600804, 0.46798832370958465, 0.50825082517253606, 0.3620851935600804, 0.5431277903401206, 0.1810425967800402, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0}
    Friend b2 As Double() = New Double() {0.84306549344750548, 0.6239426073894736, 0.77308473462175809, 0.93134489721421487, 1.0, 0.87838207445714778, 0.53449087710650955, 0.16861309868950111, 0.0, 0.0, 0.64196991121885649, 0.0, 0.50583929606850331, 0.604471635932257, 0.58330548492287115, 0.50583929606850331, 0.16861309868950111, 0.0, 0.0, 0.0, 0.33722619737900222, 0.16861309868950111, 0.0, 0.50583929606850331, 0.43585853724275586, 0.43585853724275586, 0.26724543855325478, 0.0, 0.0, 0.0, 0.72873368839217034, 0.43585853724275586, 0.16861309868950111, 0.58330548492287115, 0.56012058970266931, 0.47335681252935546, 0.33722619737900222, 0.0, 0.0, 0.0, 0.77308473462175809, 0.43585853724275586, 0.50583929606850331, 0.53449087710650955, 0.65875292956642284, 0.6239426073894736, 0.16861309868950111, 0.0, 0.0, 0.0, 0.78301498202633624, 0.39150749101316812, 0.43585853724275586, 0.71625622105011022, 0.65875292956642284, 0.68919977544141209, 0.26724543855325478, 0.16861309868950111, 0.0, 0.0, 0.53449087710650955, 0.0, 0.33722619737900222, 0.26724543855325478, 0.39150749101316812, 0.43585853724275586, 0.16861309868950111, 0.0, 0.0, 0.0, 0.16861309868950111, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0}

    Friend Function getValue(map As Double(), x As Integer, y As Integer, bins As Integer) As Double
        Return map(y * bins + x)
    End Function

    Friend Function getSignature(map As Double(), bins As Integer) As Signature
        ' find number of entries in the sparse matrix
        Dim n = 0
        For x = 0 To bins - 1
            For y = 0 To bins - 1
                If getValue(map, x, y, bins) > 0 Then
                    n += 1
                End If
            Next
        Next


        ' compute features and weights
        Dim features = New Feature2D(n - 1) {}
        Dim weights = New Double(n - 1) {}
        Dim i = 0
        For x = 0 To bins - 1
            For y = 0 To bins - 1
                Dim val = getValue(map, x, y, bins)
                If val > 0 Then
                    Dim f As Feature2D = New Feature2D(x, y)
                    features(i) = f
                    weights(i) = val
                    i += 1
                End If
            Next
        Next

        Dim signature As Signature = New Signature()
        signature.NumberOfFeatures = n
        signature.Features = features
        signature.Weights = weights

        Return signature
    End Function

    Friend Function emdDist(map1 As Double(), map2 As Double(), bins As Integer) As Double
        Dim sig1 = getSignature(map1, bins)
        Dim sig2 = getSignature(map2, bins)

        Dim dist = JFastEMD.distance(sig1, sig2, -1)

        Return dist
    End Function

    Public Sub Main()
        Console.WriteLine("test 1: " & emdDist(a0, a0, 2).ToString() & " [expected: 0.0]")
        Console.WriteLine("test 1: " & emdDist(a0, a1, 2).ToString() & " [expected: 1.0]")
        Console.WriteLine("test 2: " & emdDist(a0, a2, 2).ToString() & " [expected: 2.0]")
        Console.WriteLine("test 3: " & emdDist(b0, b1, 10).ToString() & " [expected: 19.1921]")
        Console.WriteLine("test 4: " & emdDist(b0, b2, 10).ToString() & " [expected: 25.7637]")
    End Sub
End Module